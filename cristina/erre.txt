# Read CEL files and add phenotypic data from getGEO (phenotypic data matrix "GSE13041-*.txt.gz")
gset <- getGEO(filename="~/Documents/IEO/PROJECT/phenotypic_data/GSE13041-GPL96_series_matrix.txt", GSEMatrix=TRUE)
celFilePathPN = "/Users/cristinaleal/Documents/IEO/PROJECT/data/"
celFileNames <- list.files(celFilePathPN, pattern = "CEL.gz", full.names = TRUE)
affyBatch <- ReadAffy(filenames = celFileNames)
pheno <- phenoData(gset)
phenoData(affyBatch)<-pheno
eset<-rma(affyBatch)
eset

# Analysis QA of 191 samples
#As we need to reduce the number of samples, we subset the dataset minimizing the batch effect
# Select samples trying to minimize batch effect:
# Batch effect
scandate<-protocolData(eset_batch)$ScanDate
scandate<-gsub(" .*","",scandate)
scandate<-as.Date(scandate,"%m/%d/%Y")
minscan<-min(scandate,na.rm=TRUE)
days<-scandate - minscan
sort(days)
batch <- cut(as.numeric(days), c(-1,10,100,250,350,500,700,1000 ))
batch <- as.numeric(batch)
sort(batch)
table(data.frame(Outcome = phenoData(eset)$characteristics_ch1.4, Batch = batch))

# Subsetting the batch effect --> mision quedarse con el batch 4
eset_batch <- eset[,!is.na(scandate) & scandate >= (minscan + 250)]
scandate_batch<-protocolData(eset_batch)$ScanDate
scandate_batch<-gsub(" .*","",scandate_batch)
scandate_batch<-as.Date(scandate_batch,"%m/%d/%Y")
minscan_batch<-min(scandate_batch,na.rm=TRUE)
days_batch <- scandate_batch - minscan_batch
sort(days_batch)batch_2 
batch_2<- cut(as.numeric(days_batch), c(-1,40,600))
batch_2 <- as.numeric(batch_2)
table(data.frame(Outcome = phenoData(eset_batch)$characteristics_ch1.4, Batch = batch_2))
subset <- eset_batch[,!is.na(scandate_batch) & scandate_batch <= (minscan_batch + 40)]

# Analysis of the batch effect of the subset (batch#4 of the first whole data set)
scandate_batch_subset<-protocolData(subset)$ScanDate
scandate_batch_subset<-gsub(" .*","",scandate_batch_subset)
scandate_batch_subset<-as.Date(scandate_batch_subset,"%m/%d/%Y")
minscan_batch_subset<-min(scandate_batch_subset,na.rm=TRUE)
days_batch_subset <- scandate_batch_subset - minscan_batch_subset
sort(days_batch_subset)
batch_subset<- cut(as.numeric(days_batch_subset), c(-1,10,20,35))
batch_subset <- as.numeric(batch_subset)
table(data.frame(Outcome = phenoData(subset)$characteristics_ch1.4, Batch = batch_subset))


# Creation of a new instance of AffyBatch object (fewer samples)
# Creation of a new instance of ExpressionSet object (fewer samples)

# Reanalysis of QA of the subset

# Reanalysis of Batch effect of the subset

# Differential expression of the subset

